#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <stdbool.h>
#include <assert.h>
#include <stdarg.h>

#include <util/delay.h>
#include <avr/io.h>
#include <avr/pgmspace.h>
#include <avr/interrupt.h>

#include "spi.h"
#include "st7735.h"
#include "keyboard.h"

#include "font.h"
#include "video.h"
#include "ros.h"

static const unsigned char preview[] PROGMEM = {
    0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
    0x20,0x2e,0xa9,0xab,0xaa,0xaa,0xaa,0xab,0x20,0x20,0x20,0x20,0x20,0xa9,0xab,0xaa,0xaa,0xaa,0xab,0x20,0x20,
    0x20,0x81,0xaa,0xaa,0xae,0x20,0x7f,0xaa,0xaa,0x20,0x20,0x20,0x81,0xaa,0xaa,0xae,0x8c,0x20,0x20,0x20,0x20,
    0x20,0x80,0xaa,0xaa,0xab,0xab,0xab,0xaa,0xae,0x20,0x20,0x20,0x96,0xaa,0xaa,0xab,0xab,0xab,0x2c,0x20,0x20,
    0x20,0x7f,0xaa,0xaa,0xaa,0xab,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xa2,0xae,0xae,0xae,0xaa,0xaa,0x20,0x20,
    0x20,0x9d,0xaa,0xaa,0x60,0xae,0x81,0xa5,0xab,0xaa,0xaa,0xaa,0xab,0x20,0x20,0x20,0x7f,0xaa,0xaa,0x20,0x20,
    0x20,0x97,0x81,0xaa,0x20,0x92,0x7f,0xaa,0xaa,0xae,0x20,0x7f,0xaa,0xaa,0x80,0xab,0xaa,0xaa,0xaa,0x20,0x20,
    0x20,0x8f,0x80,0xae,0x20,0x20,0x9b,0xaa,0xaa,0x20,0x20,0x29,0xaa,0xaa,0x9c,0xae,0xae,0xae,0x60,0x20,0x20,
    0x20,0x20,0x60,0x20,0x20,0x20,0x92,0xaa,0xaa,0xab,0x2c,0xa9,0xaa,0xaa,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
    0x20,0x20,0x20,0x20,0x20,0x20,0x27,0x8f,0xae,0xaa,0xaa,0xaa,0xae,0x60,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
    0x00
};

void ros_bootup(void) {
    extern void keyboard_callback(enum Virtual_Key); /* ros.c */

    /* Drivers init */
    SPI = spi_get();
    spi_device_init();
    st7735_init();
    keyboard_init(keyboard_callback);

    /* Screen init */
    clear_screen();
    ros_puts_P(0x7, preview, true);
    ros_puts(0x7, "Welcome to ROS!", true);
    ros_prompt();
    draw_graphic_cursor();
    ros_apply_output_entrys();

    /* Enter input mode */
    sei();
    sys_mode = SYSTEM_MODE_INPUT;
}

int main(void){
    ros_bootup();
    for(;;){}
}